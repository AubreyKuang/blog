# 索引（index）

### 定义

帮助MySQL高效**获取数据**的数据结构（有序）

> 如果不加索引，会从头到尾全部遍历（可能有多个）



### 优点

* 提高数据检索效率、降低数据库的IO成本
* 通过索引对数据排序，降低排序的成本、降低CPU的消耗

### 缺点

* 索引列占据空间
* 降低更新表的速度（INSERT、UPDATE、DELETE）



### 分类

- 按「数据结构」分类：**B+tree索引、Hash索引、Full-text索引**。
- 按「物理存储」分类：**聚簇索引（主键索引）、二级索引（辅助索引）**。
- 按「字段特性」分类：**主键索引、唯一索引、普通索引、前缀索引**。
- 按「字段个数」分类：**单列索引、联合索引**。



### 索引结构分类

#### 0⃣️ 二叉树索引

缺点：顺序插入时，会形成链表，查询性能大大降低

> 红黑树可解决：自平衡

数据量大时，层级深、检索速度慢

> 二叉树的弊端



#### 0⃣️ B树（B-Tree多路平衡查找树）

以一颗最大度数为5的b树为例

【每个节点最多存储4个key，5个指针】

> 因为指针是key之间的范围，所以指针数比key多1

![image-20230103231159538](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/3978/image-20230103231159538.png)

满员后：

中间元素向上分裂，其余分成两边





#### 1⃣️ B+ Tree索引

**创建的主键索引和二级索引默认使用的是 B+Tree 索引**。

> 最常见、大部分引擎都支持
>
> B树的变体

叶子节点才存放数据，非叶子节点只存放索引，而且每个节点里的数据是**按主键顺序存放**的。每一层父节点的索引值都会出现在下层子节点的索引值中

所有的节点都会出现在叶子结点

叶子结点之间形成双向链表

>  与经典B+树相比，MySQL增加了相邻叶子结点之间的指针



> 数据库的索引和数据都是存储在硬盘的，我们可以把读取一个节点当作一次磁盘 I/O 操作。那么上面的整个查询过程一共经历了 3 个节点，也就是进行了 3 次 I/O 操作。
>
> B+Tree 存储千万级的数据只需要 3-4 层高度就可以满足，这意味着从千万级的表查询目标数据最多需要 3-4 次磁盘 I/O，

##### 优点：

* 比二叉树层级少，搜索效率高
* 对于B树，叶子结点和非叶子结点都会保存，导致一页中存储的键值减少、指针减少，要保存大量数据，只能增加树的高度、降低性能。B+树只在叶子结点存储数据，单个节点的数据量更小，在相同的磁盘 I/O 次数下，就能查询更多的节点。
* B+Tree 叶子节点采用的是双链表连接，适合 MySQL 中常见的基于范围的顺序查找



##### **主键索引**

B+Tree 的叶子节点存放的是实际数据，所有完整的用户记录都存放在主键索引的 B+Tree 的叶子节点里；



##### **二级索引**

B+Tree 的叶子节点存放的是主键值，而不是实际数据。

先检二级索引中的 B+Tree 的索引值，找到对应的叶子节点，然后获取主键值。

然后再通过主键索引中的 B+Tree 树查询到对应的叶子节点，然后获取整行数据。**这个过程叫「回表」，也就是说要查两个 B+Tree 才能查到数据**。

当查询的数据是能在二级索引的 B+Tree 的叶子节点里查询到，这时就不用再查主键索引查。

**这种在二级索引的 B+Tree 就能查询到结果的过程就叫作「覆盖索引」，也就是只需要查一个 B+Tree 就能找到数据**。

> 在查询时使用了二级索引，如果查询的数据能在二级索引里查询的到，那么就不需要回表，这个过程就是覆盖索引。如果查询的数据不在二级索引里，就会先检索二级索引，找到对应的叶子节点，获取到主键值后，然后再检索主键索引，就能查询到数据了，这个过程就是回表。

#### 2⃣️ Hash索引

采用hash算法，将键值换算，映射到对应的槽位上

> 如果发生冲突，可以采用链表的方式解决

特点：

1. 只有精确匹配才有效，不支持范围查询
2. 无法用索引完成排序
3. 效率高，通常只需要一次检索（除了冲突时）

存储引擎：

Memory引擎支持hash索引，InnoDB自适应hash功能



#### 3⃣️ R-tree空间索引

MyISAM引擎的特殊索引类型，较少用（主要用于地理空间数据类型）



#### 4⃣️ Full-text全文索引

建立倒排索引，快速匹配文档



##### 不同索引在存储引擎中的支持情况

![image-20230103230543882](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/3978/image-20230103230543882.png)



### 物理存储分类



> 二级索引又称辅助索引

**聚集索引｜主键索引**选取规则：

* **如果有主键，主键索引就是聚集索引**
* 如果没有，将会用第一个唯一索引作为聚集索引
* 如果都没有，InnoDB会自动生成一个rowid作为隐藏的聚集索引



id的索引：聚集索引——叶子结点挂的是这一行的数据

其他字段（name）：二级索引——叶子结点挂的是主键





> 下面的名称：按照字母先后比大小



回表查询：先走二级索引，拿到主键；再走聚集索引，拿到这一行



### 字段特性分类









### 索引语法

* ##### 创建索引

  ```sql
  CREATE [UNIQUE|FULLTEXT] INDEX index_name ON table_name(index_col_name,...);
  ```

  如果不加 `[]` ，说明创建的是常规索引

  `Index_col_name` 表示关联的字段

  联合索引：写多个col name

  > 联合索引的col name顺序表示建立索引的先后，即先按照第一列排序，第一列相同则按照第二列排序

* ##### 查看索引

  ```sql
  SHOW INDEX FROM table_name;
  ```

* ##### 删除索引

  ```sql
  DROP INDEX index_name ON table_name;
  ```

