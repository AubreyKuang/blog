# MySQL执行流程

MySQL的架构分为：Sever层和存储引擎层

1. Sever层：建立连接、分析、执行SQL

   大多数核心功能模块都在这实现（查询缓存、执行器、所有的内置函数、跨存储引擎的操作）

2. 存储引擎层：数据的存储和提取

   不同的存储引擎共用一个Sever层

   

## 1. 连接器

连接MySQL服务，经过TCP三次握手

校验客户端的账号密码

如果账号密码正确，就会读取用户权限，后面的权限逻辑判断都基于此时的逻辑

> MySQL基于TCP协议传输
>
> 空闲连接不会一直占用，MySQL定义了连接的最大空闲时长，如果超过了就会自动断开（也可以手动断开
>
> MySQL默认服务是151个，如果超过，就会拒绝接下来的连接请求
>
> 也有长连接，短连接：使用长连接的好处就是可以**减少建立连接和断开连接**的过程；但是，使用长连接后可能会**占用内存增多**，因为 MySQL 在执行查询过程中临时**使用内存**管理连接对象，这些连接对象资源只有在连接**断开时才会释放**。
>
> 解决长连接占用：1. 定期断开长连接 2. 客户端主动重置连接





## 2. 查询缓存

解析SQL语句第一个字段

如果是查询语句（select 语句），MySQL 就会先去查询缓存（ Query Cache ）里查找缓存数据，看看之前有没有执行过这一条命令，这个查询缓存是以 key-value 形式保存在内存中

如果查询的语句命中查询缓存，那么就会直接返回 value 给客户端。如果查询的语句没有命中查询缓存中，那么就要往下继续执行，等执行完后，查询的结果就会被存入查询缓存中。

MySQL 8.0 后已经删除这个模块

> 命中率很低，因为只要一个表有更新操作，那么这个表的查询缓存就会被清空。



## 3. 解析SQL

正式执行 SQL 查询语句之前， MySQL 会先对 SQL 语句做解析，这个工作交由「解析器」来完成

1. 词法分析

   根据数据的字符串，提取关键词

2. 语法分析

   判断是否符合MySQL语法，如果语法不对，会在这个阶段报错

方便后续模块读取表名、字段、语句类型；



## 4. 执行SQL

每条`SELECT` 查询语句流程主要可以分为下面这三个阶段：

### 预处理

1. 检查查询语句中的表或者字段是否存在
2. 将select*拓展为所有列



### 优化器

确定SQL查询语句的执行方案，比如有多个索引的时候，优化器会基于查询成本的考虑，来决定选择使用哪个索引。



### 执行器

根据执行计划执行 SQL 查询语句，从存储引擎读取记录，返回给客户端；

1. 主键索引查询

2. 全表扫描

3. 索引下推

   减少**二级索引**在查询时的回表操作，提高查询的效率，因为它将 Server 层部分负责的事情，交给存储引擎层去处理了。

   >  MySQL 5.6 推出的查询优化策略